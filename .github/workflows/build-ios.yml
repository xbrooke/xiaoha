name: Build iOS IPA

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'iOS/**'
      - '.github/workflows/build-ios.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹'
        required: true
        default: 'app-store'
        type: choice
        options:
          - app-store
          - ad-hoc
          - enterprise
          - development

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ“‹ æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      run: |
        echo "macOS ç‰ˆæœ¬ï¼š"
        sw_vers
        echo ""
        echo "Xcode ç‰ˆæœ¬ï¼š"
        xcode-select --print-path
        echo ""
        echo "Swift ç‰ˆæœ¬ï¼š"
        swift --version

    - name: ğŸ”‘ å¯¼å…¥ç­¾åè¯ä¹¦
      env:
        BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # å¦‚æœæä¾›äº†è¯ä¹¦ï¼Œåˆ™å¯¼å…¥
        if [ ! -z "$BUILD_CERTIFICATE_BASE64" ]; then
          echo "å¯¼å…¥ç­¾åè¯ä¹¦..."
          
          # åˆ›å»ºä¸´æ—¶ p12 æ–‡ä»¶
          echo $BUILD_CERTIFICATE_BASE64 | base64 --decode > certificate.p12
          
          # åˆ›å»ºä¸´æ—¶ keychain
          security create-keychain -p $KEYCHAIN_PASSWORD build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p $KEYCHAIN_PASSWORD build.keychain
          
          # å¯¼å…¥è¯ä¹¦
          security import certificate.p12 -k build.keychain -P $P12_PASSWORD -T /usr/bin/codesign
          
          # è®¾ç½®å¯†é’¥é“¾è®¾ç½®
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k $KEYCHAIN_PASSWORD build.keychain
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f certificate.p12
          
          echo "âœ“ ç­¾åè¯ä¹¦å·²å¯¼å…¥"
        else
          echo "âš ï¸  æœªæä¾›ç­¾åè¯ä¹¦ï¼Œå°†ä½¿ç”¨è‡ªåŠ¨ç­¾å"
        fi

    - name: ğŸ“± å®‰è£… Provisioning Profile
      env:
        PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
      run: |
        if [ ! -z "$PROVISIONING_PROFILE_BASE64" ]; then
          echo "å®‰è£… Provisioning Profile..."
          
          # åˆ›å»º provisioning profiles ç›®å½•
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          
          # è§£ç å¹¶ä¿å­˜ profile
          echo $PROVISIONING_PROFILE_BASE64 | base64 --decode > profile.mobileprovision
          
          # å¤åˆ¶åˆ°ç³»ç»Ÿç›®å½•
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f profile.mobileprovision
          
          echo "âœ“ Provisioning Profile å·²å®‰è£…"
        else
          echo "âš ï¸  æœªæä¾› Provisioning Profileï¼Œå°†ä½¿ç”¨è‡ªåŠ¨é…ç½®"
        fi

    - name: ğŸ”¨ æ„å»º Archive
      run: |
        cd iOS
        
        echo "å¼€å§‹æ„å»º Archive..."
        
        xcodebuild archive \
          -scheme "å°å“ˆç”µæ± Widget" \
          -configuration Release \
          -derivedDataPath build/DerivedData \
          -archivePath build/app.xcarchive \
          -allowProvisioningUpdates \
          -verbose 2>&1 | tee build.log
        
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "âœ“ Archive æ„å»ºæˆåŠŸ"
        else
          echo "âŒ Archive æ„å»ºå¤±è´¥"
          cat build.log
          exit 1
        fi

    - name: ğŸ“¦ éªŒè¯ Archive
      run: |
        cd iOS
        
        if [ -d "build/app.xcarchive" ]; then
          echo "âœ“ Archive æ–‡ä»¶æœ‰æ•ˆ"
          echo ""
          echo "Archive ä¿¡æ¯ï¼š"
          du -sh build/app.xcarchive
          echo ""
          echo "Archive å†…å®¹ï¼š"
          ls -la build/app.xcarchive/Contents/
        else
          echo "âŒ Archive æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi

    - name: ğŸ“„ ç”Ÿæˆå¯¼å‡ºé…ç½®
      run: |
        cd iOS
        
        BUILD_TYPE="${{ github.event.inputs.build_type || 'app-store' }}"
        
        case $BUILD_TYPE in
          ad-hoc)
            cat > exportOptions.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>ad-hoc</string>
    <key>signingStyle</key>
    <string>automatic</string>
    <key>stripSwiftSymbols</key>
    <true/>
</dict>
</plist>
EOF
            ;;
          enterprise)
            cat > exportOptions.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>enterprise</string>
    <key>signingStyle</key>
    <string>automatic</string>
    <key>stripSwiftSymbols</key>
    <true/>
</dict>
</plist>
EOF
            ;;
          development)
            cat > exportOptions.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>development</string>
    <key>signingStyle</key>
    <string>automatic</string>
</dict>
</plist>
EOF
            ;;
          *)
            cat > exportOptions.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>app-store</string>
    <key>signingStyle</key>
    <string>automatic</string>
    <key>uploadBitcode</key>
    <false/>
    <key>uploadSymbols</key>
    <true/>
    <key>stripSwiftSymbols</key>
    <true/>
</dict>
</plist>
EOF
            ;;
        esac
        
        echo "âœ“ å¯¼å‡ºé…ç½®å·²ç”Ÿæˆ"

    - name: ğŸ“¤ å¯¼å‡º IPA
      run: |
        cd iOS
        
        echo "å¯¼å‡º IPA æ–‡ä»¶..."
        
        xcodebuild -exportArchive \
          -archivePath build/app.xcarchive \
          -exportPath build/Payload \
          -exportOptionsPlist exportOptions.plist \
          -allowProvisioningUpdates \
          -verbose 2>&1 | tee export.log
        
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "âœ“ IPA å¯¼å‡ºæˆåŠŸ"
        else
          echo "âŒ IPA å¯¼å‡ºå¤±è´¥"
          cat export.log
          exit 1
        fi

    - name: ğŸ“Š æ£€æŸ¥ IPA æ–‡ä»¶
      run: |
        cd iOS
        
        echo "æŸ¥æ‰¾ IPA æ–‡ä»¶..."
        find build/Payload -name "*.ipa" -type f
        
        IPA_FILE=$(find build/Payload -name "*.ipa" -type f | head -1)
        
        if [ -z "$IPA_FILE" ]; then
          echo "âŒ æœªæ‰¾åˆ° IPA æ–‡ä»¶"
          exit 1
        fi
        
        echo "âœ“ æ‰¾åˆ° IPA æ–‡ä»¶"
        echo ""
        echo "IPA ä¿¡æ¯ï¼š"
        echo "  æ–‡ä»¶åï¼š$(basename $IPA_FILE)"
        echo "  æ–‡ä»¶å¤§å°ï¼š$(du -h $IPA_FILE | cut -f1)"
        echo "  æ–‡ä»¶ç±»å‹ï¼š$(file $IPA_FILE | cut -d: -f2)"
        echo ""
        
        # éªŒè¯ IPA å†…å®¹
        echo "éªŒè¯ IPA åŒ…å†…å®¹..."
        unzip -l "$IPA_FILE" | head -20
        
        # ä¿å­˜ IPA è·¯å¾„åˆ°ç¯å¢ƒå˜é‡
        echo "IPA_FILE=$IPA_FILE" >> $GITHUB_ENV

    - name: ğŸ“‚ ä¸Šä¼  IPA åˆ¶å“
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa-${{ github.run_number }}
        path: iOS/build/Payload/*.ipa
        retention-days: 30
        compression-level: 0

    - name: ğŸ“ ä¸Šä¼ æ„å»ºæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: iOS/*.log
        retention-days: 7

    - name: ğŸ‰ æ„å»ºæˆåŠŸé€šçŸ¥
      if: success()
      run: |
        echo "âœ… iOS IPA æ„å»ºæˆåŠŸï¼"
        echo ""
        echo "æ„å»ºä¿¡æ¯ï¼š"
        echo "  Branch: ${{ github.ref_name }}"
        echo "  Commit: ${{ github.sha }}"
        echo "  Run ID: ${{ github.run_id }}"
        echo "  Run Number: ${{ github.run_number }}"
        echo ""
        echo "ä¸‹ä¸€æ­¥ï¼š"
        echo "  1. åœ¨ Actions æ ‡ç­¾ä¸­ä¸‹è½½ IPA æ–‡ä»¶"
        echo "  2. ä½¿ç”¨ TestFlight è¿›è¡Œæµ‹è¯•åˆ†å‘"
        echo "  3. æˆ–ç›´æ¥æäº¤åˆ° App Store"

    - name: âŒ æ„å»ºå¤±è´¥é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ iOS IPA æ„å»ºå¤±è´¥"
        echo ""
        echo "æ•…éšœæ’æŸ¥ï¼š"
        echo "  1. æŸ¥çœ‹ä¸Šé¢çš„é”™è¯¯æ—¥å¿—"
        echo "  2. æ£€æŸ¥ Xcode é¡¹ç›®é…ç½®"
        echo "  3. éªŒè¯ç­¾åè¯ä¹¦å’Œ Provisioning Profile"
        echo "  4. æŸ¥çœ‹ build.log å’Œ export.log"
        exit 1

    - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        cd iOS
        
        # åˆ é™¤æ„å»ºç¼“å­˜ï¼ˆå¯é€‰ï¼ŒèŠ‚çœç£ç›˜ç©ºé—´ï¼‰
        rm -rf build/DerivedData
        
        # åˆ é™¤ä¸´æ—¶çš„ keychainï¼ˆå¦‚æœåˆ›å»ºè¿‡ï¼‰
        if [ -f ~/Library/Keychains/build.keychain-db ]; then
          security delete-keychain build.keychain || true
        fi
        
        echo "âœ“ ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
